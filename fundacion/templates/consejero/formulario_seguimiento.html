{% extends 'config/base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block style %}
    <style type="text/css">
        [type="radio"]:not(:checked) + label, [type="radio"]:checked + label {
            padding-left: 24px;
            padding-right: 43px;
        }

        #datos_aliado {
            display: none;
        }
        #contenedor_num_menores {
            display: none;
        }

        #contenedor_num_victimas {
            display: none;
        }

        .violencia{
            display: none;
        }

        #contenedor_tipificaciones2 {
            display: none;
        }

        #contenedor_tipificaciones3 {
            display: none;
        }

        [type="checkbox"] + label {
            padding-left: 23px;
            padding-right: 30px;
        }

        #datos_canalizacion {
            display: none;
        }

        .tabs .tab a {
            border: solid 1px #EF7F13;
            color: black;
        }

        .tabs .tab a.active {
            background-color: #EF7F13;
            color: white;
        }

        .tabs .tab a:hover {
            background-color: #6E6D6D;
            color: white;
            border: none;
        }

    </style>
{% endblock %}
{% block navegador %}
    <a href="#" style="position: relative; top: 8px; right: 10px; color: white;"
       data-activates="slide-out" class="button-collapse hide-on-large-only"><i class="material-icons">menu</i></a>
    <a href="{% url 'consejero:busqueda_usuario' %}" class=" font_blanco"><img src="{% static 'imagenes/base/home.png' %}" class="responsive-img" style="position: relative; top: 5px;"></a>
{% endblock %}
{% block content %}


    <div id="content">

        <div class="row fondo_blanco" style="padding-top: 10%;">
            <div class="col s1 m1 l1"></div>
            <div class="col s10 m10 l10" style="margin-top: 0px;">
                <div class="row">
                    <div class="col s12">
                        <p class="negritas font_azul_verde center titulos">FORMULARIO SEGUIMIENTO <a href="#!">
                            <img src="{% static 'imagenes/1/interrogacion.png' %}" class="responsive-img"></a></p>
                    </div>
                </div>
                <div class="row" style="padding: 1%;">
                    <div class="col s12" style="text-align: center;">
                        <ul class="tabs">
                            <li class="tab col s4"><a class="active" href="#test1">Datos Personales</a></li>
                            <li class="tab col s4"><a href="#test2">Atención</a></li>
                            <li class="tab col s4"><a href="#test3">Histórico</a></li>
                        </ul>
                    </div>
                    <form class="col s12" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div id="test1" class="col s12" style="margin-top: 40px;">
                            <div class="row sin_marg_bottom">
                                <div class="col s12" style="margin-bottom: 20px;">
                                    <h5 class="font_gris_oscuro" style="text-align: center;">Datos Personales</h5>
                                </div>
                                <div class=" input-field col s12 m6 l6">
                                    {% render_field form.telefono %}
                                    <label for="{{ form.telefono.auto_id }}">Teléfono</label>
                                </div>
                                <div class=" input-field col s12 m6 l6">
                                    {% render_field form.nombre %}
                                    <label for="{{ form.nombre.auto_id }}"> Nombre</label>
                                </div>
                            </div>
                            <div class="row sin_marg_bottom">
                                <div class=" input-field col s12 m6 l6">
                                    {% render_field form.apellido_paterno %}
                                    <label for="{{ form.apellido_paterno.auto_id }}">Apellido Paterno</label>
                                </div>
                                <div class=" input-field col s12 m6 l6">
                                    {% render_field form.apellido_materno %}
                                    <label for="{{ form.apellido_materno.auto_id }}">Apellido Materno</label>
                                </div>
                                <div class=" input-field col s12 m6 l6">
                                    {% render_field form.fecha_nacimiento class+='datepicker' %}
                                    <label for="{{ form.fecha_nacimiento.auto_id }}">Fecha Nacimiento</label>
                                </div>
                                <div class="input-field col s12 m6 l6">
                                    {% render_field form.sexo %}
                                </div>
                            </div>
                            <div class="row sin_marg_bottom">
                                <div class=" input-field col s12 m6 l6">
                                    {% render_field form.cp onblur="cargarColonias()" %}
                                    <label for="{{ form.cp.auto_id }}">Código Postal</label>
                                </div>
                                <div class="input-field col s12 m6 l6">
                                    {% render_field form.colonia %}
                                    <label for="{{ form.colonia.auto_id }}"> Colonia</label>
                                </div>
                                <div class=" input-field col s12 m6 l6">
                                    {% render_field form.religion %}
                                    <label for="{{ form.religion.auto_id }}">Religión</label>
                                </div>
                                <div class="input-field col s12 m6 l6">
                                    {% render_field form.nivel_estudio %}
                                    <label for="{{ form.nivel_estudio.auto_id }}">Grado de estudios</label>
                                </div>
                                <div class="input-field col s12 m6 l6">
                                    {% render_field form.vive_con %}
                                    <label for="{{ form.vive_con.auto_id }}">Vive con</label>
                                </div>
                                <div class="input-field col s12 m6 l6">
                                    {% render_field form.num_hijos_menores %}
                                    <label for="{{ form.num_hijos_menores.auto_id }}"># Hijos menores</label>
                                </div>
                                <div class="input-field col s12 m6 l6">
                                    {% render_field form.num_hijos_mayores %}
                                    <label for="{{ form.num_hijos_mayores.auto_id }}"># Hijos mayores</label>
                                </div>
                            </div>
                            <div class="row sin_marg_bottom">
                                <div class="col s12 m2 l2">
                                    <p>
                                    {% render_field form.estatus %}
                                    <label for="{{ form.estatus.auto_id }}">Estatus</label>
                                    </p>
                                </div>
                                <div class="input-field col s12 m10 l10">
                                    {% render_field form.comentarios_estatus %}
                                    <label for="{{ form.comentarios_estatus.auto_id }}">Comentarios del estatus</label>
                                </div>
                                <div class="col s12" style="text-align: center; margin-top: 20px;">
                                    <button class="btn fondo_naranja redondo" type="submit" name="action">Guardar
                                    </button>
                                </div>

                            </div>
                        </div>
                    </form>
                    <div id="test3" class="col s12" style="margin-top: 40px;">
                        <div class="row sin_marg_bottom">
                            <div class="col s12" style="margin-bottom: 20px;">
                                <h5 class="font_gris_oscuro" style="text-align: center;">Histórico</h5>
                            </div>
                            <div class="input-field col s12 m4 l4">
                                <select id="consejeros">
                                </select>
                            </div>
                            <div class=" input-field col s12 m4 l4">
                                <input id="fecha_inicio" type="text" class="datepicker" required="required"
                                       placeholder="DE">
                            </div>
                            <div class=" input-field col s12 m4 l4">
                                <input id="fecha_fin" type="text" class="datepicker" required="required"
                                       placeholder="A">
                            </div>
                            <div class=" input-field col s12 m4 l4">
                                <button class="btn fondo_naranja redondo" onclick="BusquedaHistorial()">Buscar</button>
                            </div>
                        </div>
                        <div class="row sin_marg_bottom">
                            <div class="col s12">
                                <p><span class="font_naranja negritas">Última Llamada: </span> <span
                                        id="ultima_llamada"></span></p>
                            </div>
                        </div>
                        <div id="historial">

                        </div>
                    </div>


                    <div id="test2" class="col s12" style="margin-top: 40px;">
                        <div class="row sin_marg_bottom">
                            <div class="col s12" style="margin-bottom: 20px;">
                                <div class="col s12">
                    <p>
                        <input type="checkbox" id="es_aliado"/>
                        <label for="es_aliado" style="color:#EF7F13!important">Tiene aliado</label>
                    </p>
                </div>

            <div class="row" id="datos_aliado">
                <div class="row">
                    <div class="col s2"></div>
                    <div class="col s8">
                            <p style="margin-top: 0px; text-align: justify;" id="script_aliado"></p>
                    </div>
                    <div class="col s2"></div>
                </div>
                <div class="col s6">
                    <div class="row">
                        <p style="margin-top: 0px; text-align: center;">Aliado</p>
                        <div class="input-field col s12">
                            <select id="aliado" onchange="CargarLineaNegocio()">
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col s6">
                    <div class="row">
                        <p style="margin-top: 0px; text-align: center;">Línea de negocio</p>
                        <div class="input-field col s12">
                            <select id="linea_negocio">
                            </select>
                        </div>
                    </div>
                </div>
            </div>
                                <h5 class="font_gris_oscuro" style="text-align: center;">
                                    Nuevo Servicio
                                </h5>
                            </div>
                            <div class="row sin_marg_bottom">
                                <div class="col s12">
                                    <p class="font_naranja">
                                        Línea Origen
                                    </p>
                                </div>
                                <div class="col s12 txt_algn_center">
                                    <div class="col s3"></div>
                                    <div class="col s6">
                                        <div class="row">
                                            <div class="col s12">
                                                <p style="text-align: center;">¿Cómo se enteró?</p>
                                            </div>
                                            <div class="input-field col s12 m12 l12">
                                                <select id="como_se_entero">
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col s3"></div>
                                </div>
                                <div class="col s12 txt_algn_center">
                                    <div class="row">
                                        <div class="col s12">
                                            <p style="margin-top: 0px; text-align: center;">Tipo de servicio</p>
                                        </div>
                                    </div>
                                    <div id="tipo_llamada" class="row">
                                    </div>
                                   <!-- <p style="margin-top: 0px; text-align: center;" id="tipo_llamada">
                                    </p>-->
                                </div>

                                <div class="col s12 txt_algn_center">
                                   <div class="row">
                                       <div class="col s12 txt_algn_center">
                                            <div class="col s3"></div>
                                            <div class="col s6">
                                                <div class="row">
                                                    <div class="col s12">
                                                        <p style="text-align: center;"> Tipo de llamada</p>
                                                    </div>
                                                    <div class="input-field col s12 m12 l12">
                                                        <select id="tipificaciones1" onchange="CargarCatTipificacion(1)">
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col s3"></div>
                                       </div>
                                   </div>

                                    <div class="row" >
                                        <div class="col s1"></div>
                                        <div class="col s10">
                                            <div class="row" id="categoria_tipificacion1" >

                                            </div>
                                        </div>
                                        <div class="col s1"></div>
                                    </div>

                                    <!--<p style="text-align: center;" id="categoria_tipificacion1"></p>-->
                                    <div class="row">
                                        <div class=" input-field col s12 m12 l12" id="sub1">
                                        </div>
                                        <span id="agregarTipificacion1" style="cursor: pointer" class="font_naranja" onclick="showTip2(this)">+ Agregar otra tipificación</span>
                                    </div>
                                    <div id="contenedor_tipificaciones2">
                                        <div class="row">
                                            <div class=" input-field col s12 m12 l12">
                                                <select id="tipificaciones2" onchange="CargarCatTipificacion(2)">
                                                </select>
                                            </div>
                                        </div>
                                        <!--<p style="text-align: center;" id="categoria_tipificacion2"></p>-->
                                        <div class="row" >
                                            <div class="col s1"></div>
                                            <div class="col s10">
                                                <div class="row" id="categoria_tipificacion2" >

                                                </div>
                                            </div>
                                            <div class="col s1"></div>
                                        </div>
                                        <div class="row">
                                            <div class=" input-field col s12 m12 l12" id="sub2">
                                            </div>
                                            <span id="agregarTipificacion2" style="cursor: pointer;" class="font_naranja" onclick="showTip3(this)">+ Agregar otra tipificación</span>
                                            <span id="eliminar2" style="color: darkred; cursor: pointer; margin-left: 75px;" onclick="ocultarTip(2)">x Eliminar tipificación</span>
                                        </div>
                                    </div>
                                    <div id="contenedor_tipificaciones3">
                                        <div class="row">
                                            <div class=" input-field col s12 m12 l12">
                                                <select id="tipificaciones3" onchange="CargarCatTipificacion(3)">
                                                </select>
                                            </div>
                                        </div>

                                        <div class="row" >
                                            <div class="col s1"></div>
                                            <div class="col s10">
                                                <div class="row" id="categoria_tipificacion3" >

                                                </div>
                                            </div>
                                            <div class="col s1"></div>
                                        </div>

                                        <!--<p style="text-align: center;" id="categoria_tipificacion3"></p>-->
                                        <div class="row">
                                            <div class=" input-field col s12 m12 l12" id="sub3">
                                            </div>
                                            <span style="color: darkred; cursor: pointer; text-align: right" onclick="ocultarTip(3)">x Eliminar tipificación</span>
                                        </div>
                                    </div>
                                    <form action="#">
                                        <div class="row">
                                            <div class="col s12 txt_algn_center">
                                                <div class="row sin_marg_bottom">
                                                    <div class="input-field col s12 m6 l6 violencia">
                                                        <p style="margin-top: 0px; text-align: center;">Víctima</p>
                                                        <select id="victimas" onchange="verificarVictima()">
                                                        </select>
                                                    </div>
                                                    <div class="input-field col s12 m6 l6" id="contenedor_num_menores"
                                                         style="margin-top: 45px;">
                                                        <input type="number" min="1" max="5" id="num_menores_victimas"
                                                               onchange="numMenoresVictima()">
                                                        <label for="num_menores_victimas">¿Cúantos menores son
                                                            víctimas?</label>
                                                    </div>
                                                </div>

                                                <div id="contenedor_num_victimas">
                                                    <div class="row sin_marg_bottom">
                                                        <div class="input-field col s12 m2 l2">
                                                            <p style="text-align: center; text-decoration: underline; font-size: medium;">
                                                                Niño</p>
                                                        </div>
                                                        <div class="input-field col s12 m2 l2">
                                                            <p style="text-align: center; text-decoration: underline; font-size: medium;">
                                                                Edad</p>
                                                        </div>
                                                        <div class="input-field col s12 m4 l4">
                                                            <p style="text-align: center; text-decoration: underline; font-size: medium;">
                                                                Registro de nacimiento</p>
                                                        </div>
                                                        <div class="input-field col s12 m4 l4">
                                                            <p style="text-align: center; text-decoration: underline; font-size: medium;">
                                                                Quién ejerce patria potestad, tutela o guarda y
                                                                custodia</p>
                                                        </div>
                                                    </div>
                                                    <div class="row sin_marg_bottom" id="contenedor_niños_victimas">
                                                        <div class="input-field col s12 m2 l2">
                                                            <p style="text-align: center;">Niño 1</p>
                                                        </div>
                                                        <div class="input-field col s12 m2 l2">
                                                            <select id="edad">
                                                                <option>0-17</option>
                                                            </select>
                                                        </div>
                                                        <div class="col s12 m4 l4" style="margin-top: 10px">
                                                            <p>
                                                                <input type="checkbox" id="registrado"/>
                                                                <label for="registrado"
                                                                       style="color:#EF7F13!important; left: 20%">Está
                                                                    registrado?</label>
                                                            </p>
                                                        </div>
                                                        <div class="input-field col s12 m4 l4">
                                                            <select>
                                                                <option>tutor</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row sin_marg_bottom">
                                                    <div class="input-field col s12 m6 l6 violencia">
                                                        <p style="margin-top: 0px; text-align: center;">Agresor</p>
                                                        <select id="agresor">
                                                        </select>
                                                    </div>
                                                    <div class="input-field col s12 m6 l6 violencia">
                                                        <p style="margin-top: 0px; text-align: center;">Modalidad</p>
                                                        <select id="modalidad_violencia">
                                                        </select>
                                                    </div>
                                                    <div class="input-field col s12 m6 l6 violencia">
                                                        <p style="margin-top: 0px; text-align: center;">Tipo de
                                                            violencia</p>
                                                        <select id="tipos_violencia">
                                                        </select>
                                                    </div>
                                                    <div class="input-field col s12 m6 l6 violencia">
                                                        <p style="margin-top: 0px; text-align: center;">
                                                            Violentometro</p>
                                                        <select id="violentometro">
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col s3"></div>
                                                <div class="col s6">
                                                    <div class="row">
                                                        <div class="col s12">
                                                            <p style="text-align: center;">Nivel de riesgo</p>
                                                        </div>
                                                        <div class="input-field col s12 m12 l12">
                                                            <select id="nivel_riesgo">
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col s3"></div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col s12" style="padding-top: 15px;">
                                                <p style="text-align: center;">Fortalezas</p>
                                            </div>
                                            <div class="input-field col s12">
                                            <textarea id="f" class="materialize-textarea"
                                                      placeholder="Fortalezas"
                                                      style="padding-left: 14px;" maxlength="4096"></textarea>

                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col s12" style="padding-top: 15px;">
                                                <p style="text-align: center;">Recursos</p>
                                            </div>
                                            <div class="input-field col s12">
                                            <textarea id="recursos" class="materialize-textarea"
                                                      placeholder="Recursos"
                                                      style="padding-left: 14px;" maxlength="4096"></textarea>

                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col s12" style="padding-top: 15px;">
                                                <p style="text-align: center;">Debilidades</p>
                                            </div>
                                            <div class="input-field col s12">
                                            <textarea id="debilidades" class="materialize-textarea"
                                                      placeholder="Debilidades"
                                                      style="padding-left: 14px;" maxlength="4096"></textarea>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col s12" style="padding-top: 15px;">
                                                <p style="text-align: center;">Amenazas</p>
                                            </div>
                                            <div class="input-field col s12">
                                            <textarea id="amenazas" class="materialize-textarea"
                                                      placeholder="Amenazas"
                                                      style="padding-left: 14px;" maxlength="4096"></textarea>

                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col s12" style="padding-top: 15px;">
                                                <p style="text-align: center;">Intervención</p>
                                            </div>
                                            <div class="input-field col s12">
                                            <textarea id="intervencion" class="materialize-textarea"
                                                      placeholder="Intervención"
                                                      style="padding-left: 14px;" maxlength="4096"></textarea>

                                            </div>
                                        </div>
                                        <p style="text-align: center;">
                                            <!--
                                            <input type="checkbox" id="tp5"/>
                                            <label for="tp5">Checkbox</label>
                                            -->

                                        </p>
                                    </form>
                                </div>
                            </div>

                            <div class="row">
                               <div class="col s12 txt_algn_center">
                                   <div class="col s3"></div>
                                   <div class="col s6">
                                       <div class="row">
                                           <div class="col s12">
                                               <p style="text-align: center;"> Fase de cambio</p>
                                           </div>
                                           <div class="input-field col s12 m12 l12">
                                                <select id="fase_cambio">
                                                </select>
                                           </div>
                                       </div>
                                   </div>
                                   <div class="col s3"></div>
                               </div>
                            </div>


                            <div class="row">
                                <div class="col s12" style="padding-top: 15px;">
                                    <p style="text-align: center;">Examen de salud mental</p>
                                </div>

                                <div id="examen_salud_mental" >

                                </div>
                                <!--
                                <div class="input-field col s6">
                                    <p style="margin-top: 0px; text-align: center;">Ubicación Tiempo Espacio (UTE)</p>
                                    <select id="em_ute">
                                    </select>
                                </div>
                                <div class="input-field col s6">
                                    <p style="margin-top: 0px; text-align: center;">Pensamiento (P)</p>
                                    <select id="em_p">
                                    </select>
                                </div>
                                <div class="input-field col s6">
                                    <p style="margin-top: 0px; text-align: center;">Lenguaje (L)</p>
                                    <select id="em_l">
                                    </select>
                                </div>
                                <div class="input-field col s6">
                                    <p style="margin-top: 0px; text-align: center;">Memoria (M)</p>
                                    <select id="em_m">
                                    </select>
                                </div>
                                <div class="input-field col s6">
                                    <p style="margin-top: 0px; text-align: center;">Atención (A)</p>
                                    <select id="em_a">
                                    </select>
                                </div>
                                -->
                            </div>

                            <div class="row sin_marg_bottom">
                                <div class=" input-field col s12 m6 l6">
                                    <p style="margin-top: 0px; text-align: center;">Medio de contacto</p>
                                    <select id="medio_contacto">
                                    </select>
                                </div>
                            </div>
                            <div class="row sin_marg_bottom">
                                <form class="col s12">
                                    <div class="row">
                                        <div class="col s12" style="padding-top: 15px;">
                                            <p style="text-align: center;">¿Qué acciones tiene que realizar para la
                                                siguiente llamada?</p>
                                        </div>
                                        <div class="input-field col s12">
                                            <textarea id="plan_accion" class="materialize-textarea"
                                                      placeholder="Plan de acción"
                                                      style="padding-left: 14px;"></textarea>

                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="row sin_marg_bottom">
                                <div class="col s12">
                                    <p style="text-align: center;">Tareas o actividades recomendadas</p>
                                </div>
                                <div class="input-field col s12">
                                    <input id="tarea1" type="text" class="validate" required="required"
                                           placeholder="Tarea 1">
                                </div>
                                <div class="input-field col s12">
                                    <input id="tarea2" type="text" class="validate" required="required"
                                           placeholder="Tarea 2">
                                </div>
                                <div class="input-field col s12">
                                    <input id="tarea3" type="text" class="validate" required="required"
                                           placeholder="Tarea 3">
                                </div>
                            </div>
                            {% if consejero.tipo_usuario.pk == 1 %}
                                <div class="row sin_marg_bottom">
                                    <div class="col s12">
                                        <p>
                                            <input type="checkbox" id="devolver_llamada"/>
                                            <label for="devolver_llamada" style="color:#EF7F13!important">¿Acepta que le
                                                devuelvan la llamada?</label>
                                        </p>
                                    </div>
                                </div>
                            {% endif %}
                            <div class="row sin_marg_bottom">
                                <div class="col s12">
                                    <p>
                                        <input type="checkbox" id="datos_c"/>
                                        <label for="datos_c" style="color:#EF7F13!important">¿Requiere
                                            canalización?</label>
                                    </p>
                                </div>
                            </div>

                            <div class="row sin_marg_bottom" id="datos_canalizacion">
                                
                                    <div class="col s12">
                                    <select id="estados" style="width: 85%"
                                    onchange="reloadInstituciones('instituciones', 'palabrasClave1');reloadInstituciones('instituciones2', 'palabrasClave2')">
                                    </select>
                                    </div>

                                <div class="col s10">
                                    <p style="text-align: left;">1. Canalizar a: <span style="text-align: right; float: right">

                                        <a href="{% url 'administrador:list_acude_institucion' %}" target="_blank">
                                        <button class="btn fondo_naranja redondo"
                                                style="width: 125px; height: 30px; font-size: xx-small; padding-left: 10px; padding-right: 10px">
                                            + Nueva institución
                                        </button>
                                    </a></span>
                                    </p>
                                </div>

                                <div class="col s2"></div>
                                <div class="col s12 m12 l12">
                                    <div class="col s12">
                                        <input style="width: 85%" id="palabrasClave1" class="validate" 
                                        onblur="reloadInstituciones('instituciones', 'palabrasClave1')"
                                        type="text" placeholder="Buscar por palabras clave">
                                    </div>
                                    <!-- <button onclick="reloadInstituciones('instituciones')" -->
                                    <button onclick="reloadInstituciones('instituciones', 'palabrasClave1')"
                                            class="btn fondo_naranja redondo"
                                            style="width: 50px; height: 30px; font-size: xx-small; padding-left: 10px; padding-right: 10px">
                                        <i class="material-icons" style="cursor: pointer">refresh</i>
                                    </button>
                                    <select class="browser-default js-example-basic-single" id="instituciones"
                                            style="width: 85%">
                                    </select>
                                </div>
                                <div class="col s12">
                                    <br />
                                </div>
                                <br>
                                <div class="col s12">
                                    <p style="text-align: left ">2. Canalizar a:</p>
                                </div>
                                <div class="col s12 m12 l12">
                                    <div class="col s12">
                                        <input style="width: 85%" id="palabrasClave2" class="validate" 
                                        onblur="reloadInstituciones('instituciones2', 'palabrasClave2')"
                                        type="text" placeholder="Buscar por palabras clave">
                                    </div>
                                    <button onclick="reloadInstituciones('instituciones2', 'palabrasClave2')"
                                            class="btn fondo_naranja redondo"
                                            style="width: 50px; height: 30px; font-size: xx-small; padding-left: 10px; padding-right: 10px">
                                        <i class="material-icons" style="cursor: pointer">refresh</i>
                                    </button>
                                    <select class="browser-default js-example-basic-single" id="instituciones2"
                                            style="width: 85%">
                                    </select>
                                </div>
                            </div>


                            <!-- </form> -->
                        </div>
                        <div class="row">
                            <div class="col s12 center" style="margin-bottom: 5%;">
                                <!--<button class="btn fondo_naranja redondo" type="submit" name="action">Transferir
                                </button>-->
                                <button class="btn fondo_naranja redondo" name="action" onclick="GuardarLLamada()">
                                    Guardar
                                </button>
                            </div>
                        </div>
                    </div>


                </div>

            </div>
        </div>
        <div class="col s1 m1 l1"></div>
    </div>
{% endblock %}

<!--Import jQuery before materialize.js-->
<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="{% static 'js/materialize.js' %}"></script>
{% block scripts %}
    <script type="text/javascript" src="{% static 'js/crsfajax.js' %}"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
    <script type="text/javascript">
        var estado = 0;
        var examenes_mentales;
        var victima = {{ victima.pk }}
           var list_tutores;
            $(document).ready(function () {

                $('select').material_select();
                $('.button-collapse').sideNav({
                        menuWidth: 300, // Default is 300
                        edge: 'left', // Choose the horizontal origin
                        closeOnClick: false, // Closes side-nav on <a> clicks, useful for Angular/Meteor
                        draggable: true // Choose whether you can drag to open on touch screens,
                    }
                );

                $('.datepicker').on('mousedown', function (event) {
                    event.preventDefault();
                });
                $('.timepicker').on('mousedown', function (event) {
                    event.preventDefault();
                });

                $('.datepicker').pickadate({
                    selectMonths: true, // Creates a dropdown to control month
                    selectYears: 100,
                    min: [1939, 1, 1],
                    max: [2019, 1, 31],
                    format: 'yyyy-mm-dd',
                    today: 'Today',
                    clear: 'Clear',
                    close: 'Ok',
                    closeOnSelect: false, // Close upon selecting a date,
                    container: undefined // ex. 'body' will append picker to body
                });

                $('ul.tabs').tabs();


                // carga de historial de victima
                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_historial_llamada' %}?victima=" + victima,
                    cache: false,
                    success: function (json) {
                        $("#historial").empty();
                        for (i in json) {
                            llamada = {
                                victima: json[i].victima.nombre + ' ' + json[i].victima.apellido_paterno + ' ' + json[i].victima.apellido_materno,
                                consejero: json[i].consejero.get_full_name,
                                motivo_llamada: json[i].motivo.nombre,
                                id: json[i].id,
                                plan_accion: json[i].posible_solucion,
                                tareas: json[i].tareas,
                            }
                            var text_tareas = ''
                            for (i = 0; i < llamada.tareas.length; i++) {
                                text_tareas += `<p>
                                    <input type="checkbox" id="tarea${llamada.tareas[i].id}" checked="checked"/>
                                    <label for="tc1">${llamada.tareas[i].nombre}</label>
                                </p>`
                            }

                            $('#historial').append(`<div class="row sin_marg_bottom">
                                    <div class="col s12 l6 m6">
                                <p><span class="font_naranja negritas">Nombre: </span>${llamada.victima}</p>
                            </div>
                            <div class="col s12 l6 m6">
                                <p><span class="font_naranja negritas">Id Caso: </span>${llamada.id}</p>
                            </div>
                            <div class="col s12 l6 m6">
                                <p><span class="font_naranja negritas">Consejero: </span>${llamada.consejero}</p>
                            </div>
                            <div class="col s12 l6 m6">
                                <p><span class="font_naranja negritas">Motivo Llamada: </span>${llamada.motivo_llamada}</p>
                            </div>

                            <div class="col s12" style="margin-top: 20px;">
                                <p class="font_naranja negritas" style="text-align: center;">Plan de Acción</p>
                                <p>
                                    ${llamada.plan_accion}
                                </p>
                            </div>
                            <div class="col s12 txt_algn_center" style="margin-top: 20px; margin-bottom: 10%;">
                                <p style="margin-top: 0px; text-align: center;" class="font_naranja negritas">
                                    Tareas completas
                                </p>
                                ${text_tareas}
                            </div>
                            <hr></div>`
                            );
                        }
                    }
                });

                $('#datos_c').change(function () {
                    if (!$(this).prop('checked')) {
                        $('#datos_canalizacion').hide();
                    } else {
                        $('#datos_canalizacion').show();
                    }

                });

                $('#es_aliado').change(function () {
                if (!$(this).prop('checked')) {
                    $('#datos_aliado').hide();
                } else {
                    $.ajax({
                        method: "GET",
                        url: "{% url 'webservices:list_aliado' %}",
                        cache: false,
                        success: function (json) {

                            $("#aliado").empty().html(' ');
                            $('#aliado').append(
                                $("<option></option>")
                                    .attr("value", "")
                                    .text("Aliado")
                            );
                            for (i in json) {
                                $('#aliado').append(
                                    $("<option></option>")
                                        .attr("value", json[i].pk)
                                        .text(json[i].nombre)
                                );
                            }
                            $('#aliado').material_select();
                        }
                    });
                    $('#datos_aliado').show();
                }

            });

                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_tipos_violencia' %}",
                    cache: false,
                    success: function (json) {

                        $("#tipos_violencia").empty().html(' ');
                        $('#tipos_violencia').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("Tipo de violencia")
                        );
                        for (i in json) {
                            $('#tipos_violencia').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                        }
                        $('#tipos_violencia').material_select();
                    }
                });

                  $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_tutor' %}",
                    cache: false,
                    success: function (json) {
                        list_tutores = json
                    }
                });

                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_motivo_de_llamada' %}",
                    cache: false,
                    success: function (json) {

                        for (i in json) {
                            $('#tipo_llamada').append('<div class="col s4">' +
                                                          '<input class="with-gap" name="motivo_llamada" type="radio" value="' + json[i].pk + '" id="tl' + json[i].pk + '"/>' +
                                                          '<label for="tl' + json[i].pk + '">' + json[i].nombre + '</label>' +
                                                      '</div>');
                        }
                    }
                });

                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_tipificaciones' %}",
                    cache: false,
                    success: function (json) {

                        $("#tipificaciones1").empty().html(' ');
                        $('#tipificaciones1').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("Tipo de llamada")
                        );
                        $("#tipificaciones2").empty().html(' ');
                        $('#tipificaciones2').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("Tipo de llamada")
                        );
                        $("#tipificaciones3").empty().html(' ');
                        $('#tipificaciones3').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("Tipo de llamada")
                        );
                        for (i in json) {
                            $('#tipificaciones1').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                            $('#tipificaciones2').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                            $('#tipificaciones3').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                        }
                        $('#tipificaciones1').material_select();
                        $('#tipificaciones2').material_select();
                        $('#tipificaciones3').material_select();
                    }
                });

                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_nivel_riesgo' %}",
                    cache: false,
                    success: function (json) {

                        $("#nivel_riesgo").empty().html(' ');
                        $('#nivel_riesgo').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("Nivel de riesgo")
                        );
                        for (i in json) {
                            $('#nivel_riesgo').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                        }
                        $('#nivel_riesgo').material_select();
                    }
                });

                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_fase_cambio' %}",
                    cache: false,
                    success: function (json) {

                        $("#fase_cambio").empty().html(' ');
                        $('#fase_cambio').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("Fase de cambio")
                        );
                        for (i in json) {
                            $('#fase_cambio').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                        }
                        $('#fase_cambio').material_select();
                    }
                });


                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_examen_mental' %}",
                    cache: false,
                    success: function (json) {
                        examenes_mentales = json.length;
                        for (i of json ) {
                        $('#examen_salud_mental').append(`
                                <div class="input-field col s6">
                                    <p style="margin-top: 0px; text-align: center;">${ i.nombre }</p>
                                    <select id="mental_${ i.pk }">
                                    </select>
                                </div>
                        `);

                        $("#mental_"+ i.pk).empty().html(' ');

                        $('#mental_'+ i.pk).append(
                        $("<option></option>")
                            .attr("value", "")
                            .text("")
                    );

                        for (j of i.categorias) {
                        $('#mental_'+ i.pk).append(
                            $("<option></option>")
                                .attr("value", j.pk)
                                .text(j.nombre)
                            );
                        }

                        $('#mental_'+ i.pk).material_select();
                        }



                    }
                });

                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_estado_mental' %}",
                    cache: false,
                    success: function (json) {

                        $("#em_ute").empty().html(' ');
                        $("#em_p").empty().html(' ');
                        $("#em_l").empty().html(' ');
                        $("#em_m").empty().html(' ');
                        $("#em_a").empty().html(' ');

                        $('#em_ute').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("UTE")
                        );
                        for (i in json) {
                            $('#em_ute').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                        }

                        $('#em_p').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("P")
                        );
                        for (i in json) {
                            $('#em_p').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                        }

                        $('#em_l').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("L")
                        );
                        for (i in json) {
                            $('#em_l').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                        }

                        $('#em_m').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("M")
                        );
                        for (i in json) {
                            $('#em_m').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                        }

                        $('#em_a').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("A")
                        );
                        for (i in json) {
                            $('#em_a').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                        }
                        $('#em_ute').material_select();
                        $('#em_p').material_select();
                        $('#em_l').material_select();
                        $('#em_m').material_select();
                        $('#em_a').material_select();
                    }
                });


                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_modalidad_violencia' %}",
                    cache: false,
                    success: function (json) {

                        $("#modalidad_violencia").empty().html(' ');
                        $('#modalidad_violencia').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("Modalidad")
                        );
                        for (i in json) {
                            $('#modalidad_violencia').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                        }
                        $('#modalidad_violencia').material_select();
                    }
                });

                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_violentometro' %}",
                    cache: false,
                    success: function (json) {

                        $("#violentometro").empty().html(' ');
                        $('#violentometro').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("Violentometro")
                        );
                        for (i in json) {
                            $('#violentometro').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                        }
                        $('#violentometro').material_select();
                    }
                });

                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_victimas' %}",
                    cache: false,
                    success: function (json) {

                        $("#victimas").empty().html(' ');
                        $('#victimas').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("Victimas")
                        );
                        for (i in json) {
                            $('#victimas').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                        }
                        $('#victimas').material_select();
                    }
                });

                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_agresor' %}",
                    cache: false,
                    success: function (json) {

                        $("#agresor").empty().html(' ');
                        $('#agresor').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("Agresor")
                        );
                        for (i in json) {
                            $('#agresor').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                        }
                        $('#agresor').material_select();
                    }
                });


                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_medio_contacto' %}",
                    cache: false,
                    success: function (json) {

                        $("#medio_contacto").empty().html(' ');
                        $('#medio_contacto').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("Medio de contacto")
                        );
                        for (i in json) {
                            $('#medio_contacto').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                        }
                        $('#medio_contacto').material_select();
                    }
                });

                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_sucursales' %}",
                    cache: false,
                    success: function (json) {
                        var val_colonia = $('#id_colonia').val();
                        console.log('val estado', { estado })

                            $.ajax({
                                method: "GET",
                                url: "{% url 'webservices:list_estado' %}",
                                cache: false,
                                success: function (json) {

                                $("#estados").empty().html(' ');
                                $('#estados').append(
                                    $("<option></option>")
                                .attr("value", "")
                                .text("Estados")
                                );

                                for (i in json) {
                                    $('#estados').append(
                                        $("<option></option>")
                                            .attr("value", json[i].pk)
                                            .text(json[i].nombre)
                                    );
                                }
                                $('#estados').material_select();
                            }
                        });
                        

                        $("#instituciones").empty().html(' ');
                        $('#instituciones').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("Sucursal")
                        );
                        $("#instituciones2").empty().html(' ');
                        $('#instituciones2').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("Sucursal")
                        );
                        for (i in json) {
                            $('#instituciones').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                            $('#instituciones2').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                        }
                        $('#instituciones').material_select();
                        $('#instituciones2').material_select();
                        $('.js-example-basic-single').select2();
                    }
                });

                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_como_se_entero' %}",
                    cache: false,
                    success: function (json) {

                        $("#como_se_entero").empty().html(' ');
                        $('#como_se_entero').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("¿Cómo se enteró?")
                        );
                        for (i in json) {
                            $('#como_se_entero').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                        }
                        $('#como_se_entero').material_select();
                    }
                });

                // Carga de consejeros de la victima
                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_consejeros_victima' %}?victima=" + victima,
                    cache: false,
                    success: function (json) {
                        $("#consejeros").empty().html(' ');
                        $('#consejeros').append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("Consejeros")
                        );
                        for (i in json) {
                            $('#consejeros').append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].get_full_name)
                            );
                        }
                        $('#consejeros').material_select();
                    }
                });

                //Ultima llamada
                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:ultima_llamada' %}?victima=" + victima,
                    cache: false,
                    success: function (json) {
                        $("#ultima_llamada").empty().html(' ');
                        $('#ultima_llamada').html(json[0].fecha);
                    }
                });

            });

        function cargarColonias() {
            var cp = $('#id_cp').val();

            $.ajax({
                method: "GET",
                url: "{% url 'webservices:list_cp' %}?cp=" + cp,
                cache: false,
                success: function (json) {
                    if (json.length > 0){
                        $("#id_colonia").empty().html(' ');
                            $('#id_colonia').append(
                                $("<option></option>")
                                    .attr("value", "")
                                    .text("Colonia")
                            );
                            for (i in json) {
                                $('#id_colonia').append(
                                    $("<option></option>")
                                        .attr("value", json[i].pk)
                                        .text(json[i].nombre)
                                );
                            }
                            $('#id_colonia').material_select();
                    } else {
                        console.log('no hay colonias registradas con ese cp')
                    }
                }
            });
        }

        function CargarCatTipificacion(elem) {
            var tipificacion = $('#tipificaciones'+elem).val();
            $('#categoria_tipificacion'+elem).empty().html(' ');
            if (tipificacion !== '') {
                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_tipificaciones_categorias' %}?tipificacion=" + tipificacion,
                    cache: false,
                    success: function (json) {

                        for (i in json) {
                            $('#categoria_tipificacion'+elem).append('<div class="col s6">' +
                                                                         '<input class="with-gap" onclick="checkSubcategorias('+json[i].pk+','+elem+')" name="categoria_tipificacion'+elem+'" type="radio" value="' + json[i].pk + '" id="tic' + json[i].pk + '_'+elem+'"/>' +
                                                                         '<label for="tic' + json[i].pk + '_'+elem+'">' + json[i].nombre + '</label>' +
                                                                      '</div>');
                        }
                    }
                });
            }
        }

        function checkSubcategorias(pk_categoria, elemento) {
            $('#sub'+elemento).empty().html(' ');
            var tipi1 = $("input[name='categoria_tipificacion1']:checked").val();
            var tipi2 = $("input[name='categoria_tipificacion2']:checked").val();
            var tipi3 = $("input[name='categoria_tipificacion3']:checked").val();
            if (tipi1 == 63 || tipi2 == 63 || tipi3 == 63){
                $(".violencia").show();
            }
            else{$(".violencia").hide();}
            $.ajax({
                method: "GET",
                url: "{% url 'webservices:list_tipificaciones_subcategorias' %}?categoria=" + pk_categoria,
                cache: false,
                success: function (json) {
                    if (json.length > 0){
                        var sel;
                        $("#sub"+elemento).empty().html(' ');
                        selector_html = '<select id="subcategoria'+elemento+'">'

                           selector_html = selector_html + '<option value>Subcategoría</option>'
                        for (i in json) {
                            selector_html = selector_html+ '<option value="'+json[i].pk+'">'+json[i].nombre+'</option>'
                        }
                        selector_html = selector_html +'</select>'


                        $("#sub"+elemento).html(selector_html);
                        $("#subcategoria"+elemento).material_select();
                    }
                    else {
                        console.log('No tiene subcategorias')
                    }

                }
            });
        }

        function CargarPalabrasClave() {
            var val_estados = $('#estados').val();
            var palabrasClave = encodeURIComponent($('#palabrasClave1').val());
            var url =  "{% url 'webservices:list_sucursales' %}";
            var string_palabras_clave = (palabrasClave == '') ? '' :   "?keywords=" + palabrasClave;
            var string_estado = (val_estados == '') ? '' :   "?estado=" + val_estados;

            if (palabrasClave != '' && palabrasClave != '%20' ) {
                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_sucursales' %}?keywords=" + palabrasClave + '&estado=',
                    cache: false,
                    success: function (json) {
                        if (json.length > 0){
                            console.log('res json', json)
                            $("#instituciones").empty().html(' ');
                            $('#instituciones').append(
                                $("<option></option>")
                                    .attr("value", "")
                                    .text("Sucursal")
                            );
                            for (i in json) {
                                $('#instituciones').append(
                                    $("<option></option>")
                                        .attr("value", json[i].pk)
                                        .text(json[i].nombre)
                                );
                                // $('#instituciones2').append(
                                //     $("<option></option>")
                                //         .attr("value", json[i].pk)
                                //         .text(json[i].nombre)
                                // );
                            }
                            $('#instituciones').material_select();
                            // $('#instituciones2').material_select();
                            $('.js-example-basic-single').select2();
                        }
                        else {
                            console.log('no se encontraron resultados')
                        }
                    }
                });
            } else {
                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_sucursales' %}" ,
                    cache: false,
                    success: function (json) {
                        if (json.length > 0){
                            console.log('res json', json)
                            $("#instituciones").empty().html(' ');
                            $('#instituciones').append(
                                $("<option></option>")
                                    .attr("value", "")
                                    .text("Sucursal")
                            );
                            for (i in json) {
                                $('#instituciones').append(
                                    $("<option></option>")
                                        .attr("value", json[i].pk)
                                        .text(json[i].nombre)
                                );
                                // $('#instituciones2').append(
                                //     $("<option></option>")
                                //         .attr("value", json[i].pk)
                                //         .text(json[i].nombre)
                                // );
                            }
                            $('#instituciones').material_select();
                            // $('#instituciones2').material_select();
                            $('.js-example-basic-single').select2();
                        }
                        else {
                            console.log('no se encontraron resultados')
                        }
                    }
                });
            }
        }


        function CargarPalabrasClave2() {
            var palabrasClave = encodeURIComponent($('#palabrasClave1').val());
            if (palabrasClave != '' && palabrasClave != '%20' ) {
                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_sucursales' %}?keywords=" + palabrasClave,
                    cache: false,
                    success: function (json) {
                        if (json.length > 0){
                            console.log('res json', json)
                            $("#instituciones2").empty().html(' ');
                            $('#instituciones2').append(
                                $("<option></option>")
                                    .attr("value", "")
                                    .text("Institución")
                            );
                            for (i in json) {
                                $('#instituciones2').append(
                                    $("<option></option>")
                                        .attr("value", json[i].pk)
                                        .text(json[i].nombre)
                                );
                            }
                            $('#instituciones2').material_select();
                            $('.js-example-basic-single').select2();
                        }
                        else {
                            console.log('no se encontraron resultados')
                        }
                    }
                });
            } else {
                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_sucursales' %}" ,
                    cache: false,
                    success: function (json) {
                        if (json.length > 0){
                            console.log('res json', json)
                            $("#instituciones2").empty().html(' ');
                            $('#instituciones2').append(
                                $("<option></option>")
                                    .attr("value", "")
                                    .text("Institución")
                            );
                            for (i in json) {
                                $('#instituciones2').append(
                                    $("<option></option>")
                                        .attr("value", json[i].pk)
                                        .text(json[i].nombre)
                                );
                                // $('#instituciones2').append(
                                //     $("<option></option>")
                                //         .attr("value", json[i].pk)
                                //         .text(json[i].nombre)
                                // );
                            }
                            $('#instituciones2').material_select();
                            // $('#instituciones2').material_select();
                            $('.js-example-basic-single').select2();
                        }
                        else {
                            console.log('no se encontraron resultados')
                        }
                    }
                });
            }
        }

        function CargarLineaNegocio() {
            var aliado = $('#aliado').val();
            $('#linea_negocio').empty().html(' ');
            if (aliado !== '') {
                $.ajax({
                    method: "GET",
                    url: "{% url 'webservices:list_line_negocio' %}?aliado=" + aliado,
                    cache: false,
                    success: function (json) {
                        if (json.length == 0) {
                            $("#script_aliado").empty().html(' ');
                            $("#linea_negocio").empty().html(' ');
                            $('#linea_negocio').append(
                                $("<option></option>")
                                    .attr("value", "")
                                    .text("Línea de negocio")
                            );
                            $.ajax({
                                method: "GET",
                                url: "/ws/list_aliado?aliado="+aliado,
                                cache: false,
                                success: function (json) {
                                    console.log(json);
                                    var script_aliado = json[0].script;
                                    $("#script_aliado").append(script_aliado);
                                }
                            });
                            $('#linea_negocio').material_select();

                        } else {

                            var script_aliado = json[0].aliado.script;
                            $("#script_aliado").empty().html(' ');
                            $("#script_aliado").append(script_aliado);
                            $("#linea_negocio").empty().html(' ');
                            $('#linea_negocio').append(
                                $("<option></option>")
                                    .attr("value", "")
                                    .text("Línea de negocio")
                            );
                            for (i in json) {
                                $('#linea_negocio').append(
                                    $("<option></option>")
                                        .attr("value", json[i].pk)
                                        .text(json[i].nombre)
                                );
                            }
                            $('#linea_negocio').material_select();
                        }
                    }
                });
            }
        }

        function GuardarLLamada() {
                                    console.log('examenes mentales', examenes_mentales);
            //var vida_riesgo = $("input[name='riesgo']:checked").val();
            var num_menores = $('#num_menores_victimas').val();
            var motivo_llamada = $("input[name='motivo_llamada']:checked").val();

            var nivel_riesgo = $('#nivel_riesgo').val();
            var f = $('#f').val();
            var debilidades = $('#debilidades').val();
            var amenazas = $('#amenazas').val();
            var recursos = $('#recursos').val();
            var intervencion = $('#intervencion').val();
            var estado_mental_ute = $('#em_ute').val();
            var estado_mental_p = $('#em_p').val();
            var estado_mental_l = $('#em_l').val();
            var estado_mental_m = $('#em_m').val();
            var estado_mental_a = $('#em_a').val();
            var fase_cambio = $('#fase_cambio').val();
            var modalidad_violencia = $('#modalidad_violencia').val();
            var tipo_violencia = $('#tipos_violencia').val();
            var violentometro = $('#violentometro').val();
            var victimas = $('#victimas').val();
            var agresor = $('#agresor').val();
            var medio_conatacto = $('#medio_contacto').val();
            var plan_accion = $('#plan_accion').val();
            var datos_canalizacion = $('#datos_c').prop('checked');
            var sucursal1 = $('#instituciones').val();
            var sucursal2 = $('#instituciones2').val();
            var como_se_entero = $('#como_se_entero').val();
            //Registro temporal de tareas
            var tarea1 = $('#tarea1').val();
            var tarea2 = $('#tarea2').val();
            var tarea3 = $('#tarea3').val();
            var aliado =null;
            var linea_negocio = null;
            if ($("#es_aliado").prop('checked')) {
                aliado = $("#aliado").val();
                linea_negocio = $("#linea_negocio").val();
            }
            var examen_mental = [];
            for (var i = 1; i < examenes_mentales + 1; i++) {
                var valorExamen = $('#mental_'+ i).val();
                var objExamenes = {}

                console.log('valor mental ', valorExamen);
                if (valorExamen != ''){
                    objExamenes.pk = valorExamen
                    examen_mental.push(objExamenes);
                }
            }


            let victimas_menores = [];
            for (var i = 1; i <= num_menores; i++) {
                const obj = {}
                obj.edad = $("#select_edad"+ i).val();
                obj.registro = $("#registrado"+ i).prop('checked');
                obj.tutor = $("#select_tutor"+ i).val();
                victimas_menores.push(obj);
                // victimas_menores[i].edad = $("#select_edad"+ i).val();

            }
            console.log('victimas', victimas_menores);

            var tipificacion1 = null, tipificacion2 = null, tipificacion3 = null;
            var categoria_tipificacion1 = null, categoria_tipificacion2 = null, categoria_tipificacion3 = null;
            var subcategoria_tipificacion1 = null, subcategoria_tipificacion2 = null, subcategoria_tipificacion3 = null;


            switch (num_tipificaciones) {
                case 1:
                    tipificacion1 = $('#tipificaciones1').val();
                    categoria_tipificacion1 = $("input[name='categoria_tipificacion1']:checked").val();
                    subcategoria_tipificacion1 = $('#subcategoria1').val();
                    break;
                case 2:
                    tipificacion1 = $('#tipificaciones1').val();
                    categoria_tipificacion1 = $("input[name='categoria_tipificacion1']:checked").val();
                    subcategoria_tipificacion1 = $('#subcategoria1').val();

                    tipificacion2 = $('#tipificaciones2').val();
                    categoria_tipificacion2 = $("input[name='categoria_tipificacion2']:checked").val();
                    subcategoria_tipificacion2 = $('#subcategoria2').val();
                    break;
                case 3:
                    tipificacion1 = $('#tipificaciones1').val();
                    categoria_tipificacion1 = $("input[name='categoria_tipificacion1']:checked").val();
                    subcategoria_tipificacion1 = $('#subcategoria1').val();

                    tipificacion2 = $('#tipificaciones2').val();
                    categoria_tipificacion2 = $("input[name='categoria_tipificacion2']:checked").val();
                    subcategoria_tipificacion2 = $('#subcategoria2').val();

                    tipificacion3 = $('#tipificaciones3').val();
                    categoria_tipificacion3 = $("input[name='categoria_tipificacion3']:checked").val();
                    subcategoria_tipificacion3 = $('#subcategoria3').val();
                    break;
                default:
                    break;
            }

            if (typeof tipificacion1 === "undefined" || tipificacion1 === "") tipificacion1 = null;
            if (typeof tipificacion2 === "undefined" || tipificacion2 === "") tipificacion2 = null;
            if (typeof tipificacion3 === "undefined" || tipificacion3 === "") tipificacion3 = null;
            if (typeof categoria_tipificacion1 === "undefined" || categoria_tipificacion1 === "") categoria_tipificacion1 = null;
            if (typeof categoria_tipificacion2 === "undefined" || categoria_tipificacion2 === "")categoria_tipificacion2 = null;
            if (typeof categoria_tipificacion3 === "undefined" || categoria_tipificacion3 === "") categoria_tipificacion3 = null;
            if (typeof subcategoria_tipificacion1 === "undefined" || subcategoria_tipificacion1 === "") subcategoria_tipificacion1 = null;
            if (typeof subcategoria_tipificacion2 === "undefined" || subcategoria_tipificacion2 === "") subcategoria_tipificacion2 = null;
            if (typeof subcategoria_tipificacion3 === "undefined" || subcategoria_tipificacion3 === "") subcategoria_tipificacion3 = null;

            var devolver_llamada = false;
            {% if consejero.tipo_usuario.pk == 1 %}
                devolver_llamada = $('#devolver_llamada').prop('checked'); //Esta seleccionado devolver llamada
            {% endif %}

         var rawData = {
                    victima: victima,
                    motivo_llamada: "" ? null : motivo_llamada,
                    categoria_tipificacion1: categoria_tipificacion1,
                    categoria_tipificacion2: categoria_tipificacion2,
                    categoria_tipificacion3: categoria_tipificacion3,
                    subcategoria_tipificacion1: subcategoria_tipificacion1,
                    subcategoria_tipificacion2: subcategoria_tipificacion2,
                    subcategoria_tipificacion3: subcategoria_tipificacion3,
                    nivel_riesgo: "" ? null : nivel_riesgo,
                    f: f,
                    debilidades: debilidades,
                    amenazas: amenazas,
                    recursos: recursos,
                    intervencion: intervencion,
                    estado_mental_ute: estado_mental_ute,
                    estado_mental_p: estado_mental_p,
                    estado_mental_l: estado_mental_l,
                    estado_mental_m: estado_mental_m,
                    estado_mental_a: estado_mental_a,
                    fase_cambio: "" ? null :  fase_cambio,
                    modalidad_violencia: modalidad_violencia=="" ? null : modalidad_violencia,
                    tipo_violencia: tipo_violencia=="" ? null : tipo_violencia,
                    violentometro: violentometro=="" ? null : violentometro,
                    victimas: victimas=="" ? null : victimas,
                    agresor: agresor=="" ? null : agresor,
                    medio_contacto: medio_conatacto,
                    posible_solucion: plan_accion,
                    sucursal1: sucursal1=="" ? null : sucursal1,
                    sucursal2: sucursal2=="" ? null : sucursal2,
                    como_se_entero: "" ? null : como_se_entero,
                    tarea1: tarea1,
                    tarea2: tarea2,
                    tarea3: tarea3,
                    examen_mental: examen_mental,
                    devolver_llamada: devolver_llamada,
                    aliado: aliado,
                    linea_negocio: linea_negocio,
                    victimas_menores: victimas_menores
                }


                console.log('rawdata', rawData)
            rawData = JSON.stringify(rawData)
            $.ajax({
                type: 'post',
                data: rawData,
                dataType: 'json',
                contentType: 'application/json',
                url: "{% url 'webservices:registro_seguimiento' %}",
                cache: false,
                success: function (json) {
                    window.location.href = "{% url 'consejero:registro_seguimiento' victima.pk %}";
                },
                error: function (request) {
                    alert(request.responseText);
                    var error = request
                }
            });
        }

        function BusquedaHistorial() {
            var mensaje_error = validarBusqueda()
            if (mensaje_error !== 'Revisa los datos introducidos de:') {
                alert(mensaje_error);
                return
            }
            var consejero = $('#consejeros').val();
            var f_inicio = $('#fecha_inicio').val();
            var f_fin = $('#fecha_fin').val();
            $.ajax({
                method: "GET",
                url: "{% url 'webservices:list_historial_llamada' %}?victima=" + victima + '&consejero=' + consejero + '&f_inicio=' + f_inicio + '&f_fin=' + f_fin,
                cache: false,
                success: function (json) {
                    $("#historial").empty();
                    console.log(json);
                    for (i in json) {
                        llamada = {
                            victima: json[i].victima.nombre + ' ' + json[i].victima.apellido_paterno + ' ' + json[i].victima.apellido_materno,
                            consejero: json[i].consejero.get_full_name,
                            motivo_llamada: json[i].motivo.nombre,
                            id: json[i].id,
                            plan_accion: json[i].posible_solucion,
                            tareas: json[i].tareas,
                        }
                        var text_tareas = ''
                        for (i = 0; i < llamada.tareas.length; i++) {
                            text_tareas += `<p>
                                    <input type="checkbox" id="tarea${llamada.tareas[i].id}" checked="checked"/>
                                    <label for="tc1">${llamada.tareas[i].nombre}</label>
                                </p>`
                        }

                        $('#historial').append(`<div class="row sin_marg_bottom">
                                    <div class="col s12 l6 m6">
                                <p><span class="font_naranja negritas">Nombre: </span>${llamada.victima}</p>
                            </div>
                            <div class="col s12 l6 m6">
                                <p><span class="font_naranja negritas">Id Caso: </span>${llamada.id}</p>
                            </div>
                            <div class="col s12 l6 m6">
                                <p><span class="font_naranja negritas">Consejero: </span>${llamada.consejero}</p>
                            </div>
                            <div class="col s12 l6 m6">
                                <p><span class="font_naranja negritas">Motivo Llamada: </span>${llamada.motivo_llamada}</p>
                            </div>

                            <div class="col s12" style="margin-top: 20px;">
                                <p class="font_naranja negritas" style="text-align: center;">Plan de Acción</p>
                                <p>
                                    ${llamada.plan_accion}
                                </p>
                            </div>
                            <div class="col s12 txt_algn_center" style="margin-top: 20px; margin-bottom: 10%;">
                                <p style="margin-top: 0px; text-align: center;" class="font_naranja negritas">
                                    Tareas completas
                                </p>
                                ${text_tareas}
                            </div>
                            <hr></div>`
                        );
                    }
                }
            });

        }

        function validarBusqueda() {
            var consejero = $('#consejeros').val();
            var f_inicio = $('#fecha_inicio').val();
            var f_fin = $('#fecha_fin').val();
            var mensaje_error = 'Revisa los datos introducidos de:';
            if (consejero == '') {
                mensaje_error += '\nSelecciona un Consejero';
            }
            if (f_inicio == '') {
                mensaje_error += '\nFecha inicial';
            } else {
                var inicial = new Date(f_inicio)
            }
            if (f_fin == '') {
                mensaje_error += '\nFecha final';
            } else {
                var final = new Date(f_fin)
            }
            if (f_inicio !== '' && f_fin !== '') {
                if (inicial > final) {
                    mensaje_error += '\nLa fecha inicial es mayor a la final'
                }
            }
            return mensaje_error
        }

        function reloadInstituciones(id_select, idPalabrasClave) {
            var val_estados = $('#estados').val();
            var palabrasClave = $('#' + idPalabrasClave).val();
            var url =  "{% url 'webservices:list_sucursales' %}";
            var string_palabras_clave = (palabrasClave == '') ? '?keywords=' :   "?keywords=" + palabrasClave;
            var string_estado = (val_estados == '' || val_estados == undefined) ? '' :   "&estado=" + val_estados;
            console.log('url completo', url + string_palabras_clave + string_estado)
            $.ajax({
                method: "GET",
                url: url + string_palabras_clave + string_estado,
                cache: false,
                success: function (json) {
                    if (json.length > 0) {
                        $("#"+id_select).empty().html(' ');
                        $("#"+id_select).append(
                            $("<option></option>")
                                .attr("value", "")
                                .text("Sucursales")
                        );
                        for (i in json) {
                            $("#"+id_select).append(
                                $("<option></option>")
                                    .attr("value", json[i].pk)
                                    .text(json[i].nombre)
                            );
                        }
                        $("#"+id_select).material_select();
                        $('.js-example-basic-single').select2();
                    } else {
                        console.log('no se encontraron resultados')
                    }
                }
            });
        }
        num_tipificaciones = 1
        function showTip2(elemento) {
            $("#"+elemento.id).hide();
            $("#contenedor_tipificaciones2").show();
            num_tipificaciones += 1;
        }
        function showTip3(elemento) {
            $("#"+elemento.id).hide();
            $("#eliminar2").hide();
            $("#contenedor_tipificaciones3").show();
            num_tipificaciones += 1;
        }
        function ocultarTip(num_elemento) {
            $("#contenedor_tipificaciones"+num_elemento).hide();
            num_tipificaciones -= 1;
            $("#eliminar"+num_tipificaciones).show();
            $("#agregarTipificacion"+num_tipificaciones).show();
        }


        function verificarVictima() {
            var victima = $('#victimas').val();
            if (victima==1){
                $('#num_menores_victimas').val('');
                $('#contenedor_num_menores').show();
                 // $('#contenedor_num_victimas').show();
                return
            }
            $('#contenedor_num_menores').hide();
            $('#num_menores_victimas').val('');
        }
        function numMenoresVictima() {
            $("#contenedor_niños_victimas").empty().html(' ');
            var num_menores = $('#num_menores_victimas').val();
            if (num_menores > 0 && num_menores <= 5){
                $('#contenedor_num_victimas').show();

                for (i=1; i<=num_menores; i++) {
                $('#contenedor_niños_victimas').append(
                    `
                       <div class="input-field col s12 m2 l2">
                           <p style="text-align: center;">Menor ${i }</p>
                       </div>
                       <div class="input-field col s12 m2 l2">
                           <select id="select_edad${i}">

                           </select>
                       </div>
                       <div class="col s12 m4 l4" style="margin-top: 10px">
                           <p>
                               <input type="checkbox" id="registrado${ i }"/>
                               <label for="registrado${ i }" style="color:#EF7F13!important; left: 20%">Está
                                   registrado?</label>
                           </p>
                       </div>
                       <div class="input-field col s12 m4 l4">
                           <select id="select_tutor${i}">

                           </select>
                       </div>
                        `
                        );

                    for (j=0; j<=17; j++){
                        $('#select_edad' + i).append($('<option/>').html(j));
                    }

                    list_tutores.forEach(function(el) {
                        $('#select_tutor' + i).append($('<option/>').attr('value',el.pk).text(el.nombre))
                    })

                }

                $('select').material_select();
                          // selector_html = selector_html + '<option value>Subcategoría</option>'
                        // for (i in json) {
                           // selector_html = selector_html+ '<option value="'+json[i].pk+'">'+json[i].nombre+'</option>'
                        // }
                        // selector_html = selector_html +'</select>'
                        var plantilla_menores =
                                                    `<div class="row sin_marg_bottom">

                                                   <div class="input-field col s12 m2 l2">
                                                       <p style="text-align: center;">Niño 1</p>
                                                   </div>
                                                   <div class="input-field col s12 m2 l2">
                                                       <select>
                                                           <option>0-17</option>
                                                       </select>
                                                   </div>
                                                   <div class="col s12 m4 l4" style="margin-top: 10px">
                                                       <p>
                                                           <input type="checkbox" id="registrado"/>
                                                           <label for="registrado" style="color:#EF7F13!important; left: 20%">Está
                                                               registrado?</label>
                                                       </p>
                                                   </div>
                                                   <div class="input-field col s12 m4 l4">
                                                       <select>
                                                           <option>tutor</option>
                                                       </select>
                                                   </div>
                                               </div>`
            }
            else if (num_menores<=0){
                alert('Escribe un número entre 1-5')
            }
            else if (num_menores>5){
                alert('Escibe un número menor o igual a 5')
            }

        }

    </script>
{% endblock %}


